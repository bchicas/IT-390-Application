<!DOCTYPE html>
<!-- Website Template by freewebsitetemplates.com -->
<html>
  <head>
    <meta charset="UTF-8" />
    <title id="title"></title>
    <link rel="stylesheet" href="css/style.css" type="text/css" />
  </head>
  <body>
    <div id="page">
      <div id="header">
        <a href="index.html" class="logo"
          ><img src="images/bookworm.png" alt=""
        /></a>
        <div class="navigation">
          <ul class="primary">
            <li>
              <a href="index.html">home</a>
            </li>
            <li>
              <a href="about.html">about</a>
            </li>
          </ul>
          <ul class="secondary">
            <li>
              <a href="browse.html">browse</a>
            </li>
            <li>
              <button id="sign-in-out-button">Sign In</button>
              <script type="module">
                // Import the functions you need from the SDKs you need
                import { initializeApp } from "https://www.gstatic.com/firebasejs/9.19.1/firebase-app.js";
                import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.19.1/firebase-analytics.js";
                import {
                  getAuth,
                  signInWithPopup,
                  signOut,
                  GoogleAuthProvider,
                  setPersistence,
                  browserSessionPersistence,
                } from "https://www.gstatic.com/firebasejs/9.19.1/firebase-auth.js";
                // TODO: Add SDKs for Firebase products that you want to use
                // https://firebase.google.com/docs/web/setup#available-libraries

                // Your web app's Firebase configuration
                // For Firebase JS SDK v7.20.0 and later, measurementId is optional
                const firebaseConfig = {
                  apiKey: "AIzaSyCL5XSNiNJ6rZBora7WfhlecToSJO8p8Mo",
                  authDomain: "bookworm-12345.firebaseapp.com",
                  projectId: "bookworm-12345",
                  storageBucket: "bookworm-12345.appspot.com",
                  messagingSenderId: "1015960933719",
                  appId: "1:1015960933719:web:a6e9de27a3d48f3b91da12",
                  measurementId: "G-BSDLSJYQC7",
                };

                // Initialize Firebase
                const app = initializeApp(firebaseConfig);
                const analytics = getAnalytics(app);
                const provider = new GoogleAuthProvider();
                const auth = getAuth();

                setPersistence(auth, browserSessionPersistence)
                  .then(() => {
                    // Existing and future Auth states are now persisted in the current
                    // session only. Closing the window would clear any existing state even
                    // if a user forgets to sign out.
                    // ...
                  })
                  .catch((error) => {
                    // Handle Errors here.
                    const errorCode = error.code;
                    const errorMessage = error.message;
                  });
                const userInfoDiv = document.getElementById("user-info");

                // Listen for changes in the authentication state of the user
                auth.onAuthStateChanged((user) => {
                  if (user) {
                    // User is signed in, show the #user-info div
                    userInfoDiv.style.display = "block";

                    // Update the user's name and email in the #user-info div
                    document.getElementById("user-name").textContent =
                      user.displayName;
                  } else {
                    // User is signed out, hide the #user-info div
                    userInfoDiv.style.display = "none";
                  }
                });
                const signInOutButton =
                  document.getElementById("sign-in-out-button");
                auth.onAuthStateChanged((user) => {
                  if (user) {
                    // User is signed in
                    signInOutButton.textContent = "Sign Out";
                    signInOutButton.addEventListener("click", () => {
                      signOut(auth)
                        .then(() => {
                          // Sign-out successful.
                        })
                        .catch((error) => {
                          // An error happened.
                        });
                    });
                  } else {
                    // User is signed out
                    signInOutButton.textContent = "Sign In";
                    signInOutButton.addEventListener("click", () => {
                      const provider = new GoogleAuthProvider();

                      // Set the provider to prompt the user to select an account
                      provider.setCustomParameters({
                        prompt: "select_account",
                      });

                      signInWithPopup(auth, provider)
                        .then((result) => {
                          // This gives you a Google Access Token. You can use it to access the Google API.
                          const credential =
                            GoogleAuthProvider.credentialFromResult(result);
                          const token = credential.accessToken;
                          // The signed-in user info.
                          const user = result.user;
                          // IdP data available using getAdditionalUserInfo(result)
                          // ...
                          document.getElementById("user-name").textContent =
                            user.displayName;
                          document.getElementById("user-email").textContent =
                            user.email;
                        })
                        .catch((error) => {
                          // Handle Errors here.
                          const errorCode = error.code;
                          const errorMessage = error.message;
                          // The email of the user's account used.
                          const email = error.customData.email;
                          // The AuthCredential type that was used.
                          const credential =
                            GoogleAuthProvider.credentialFromError(error);
                          // ...
                        });
                    });
                  }
                });
              </script>
            </li>
          </ul>
        </div>
      </div>
      <div id="body">
        <div class="content">
          <div id="user-info">
            <p>Welcome, <span id="user-name"></span>. Currently Viewing:</p>
          </div>
          <h3
            id="bookTitle"
            style="display: flex; justify-content: center; align-items: center"
          ></h3>
          <br />
          <img
            src=""
            alt=""
            width="450px"
            id="cover"
            style="display: block; margin: 0 auto"
          />
          <h3>Author:</h3>
          <p id="author"></p>
          <h3>Description:</h3>
          <p id="description"></p>
          <h3>Date Published:</h3>
          <p id="year"></p>
          <h3>Length:</h3>
          <p id="length"></p>
          <h3>Score:</h3>
          <p id="score"></p>
          <h3>Where To Buy:</h3>
          <p>
            <a href="" id="buyLink">Buy on Amazon</a>
          </p>
          <hr />
        </div>
      </div>
      <div id="footer">
        <p>
          Copyright Team 4 2023 | This page does not gather any personal
          information
        </p>
      </div>
    </div>
    <script>
      const urlParams = new URLSearchParams(window.location.search);
      const title = urlParams.get("title");
      const author = urlParams.get("author");
      const year = urlParams.get("year");
      const cover = urlParams.get("cover");

      // Call OpenLibrary API to get book information
      fetch(`https://openlibrary.org/search.json?title=${title}`)
        .then((response) => response.json())
        .then((data) => {
          const book = data.docs[0];
          const olid = book.key.split("/")[2];

          // Call OpenLibrary API to get the book length
          fetch(`https://openlibrary.org/works/${olid}/editions.json`)
            .then((response) => response.json())
            .then((data) => {
              let length = "";

              // Find the first edition that has a valid number of pages
              for (let i = 0; i < data.entries.length; i++) {
                const edition = data.entries[i];
                if (edition.number_of_pages) {
                  length = edition.number_of_pages;
                  break;
                }
              }

              // Update the book length in the HTML
              document.getElementById("length").innerText = `${length} pages`;
            })
            .catch((error) => console.error(error));

          // Call OpenLibrary API to get the book description
          fetch(`https://openlibrary.org/works/${olid}.json`)
            .then((response) => response.json())
            .then((data) => {
              const description = data.description;

              // Update the book description in the HTML
              document.getElementById("description").innerText = description;
            })
            .catch((error) => console.error(error));

          fetch(`https://openlibrary.org/works/${olid}/ratings.json`)
            .then((response) => response.json())
            .then((data) => {
              const rating = data.summary.average.toFixed(2);
              document.getElementById("score").innerText = rating;
            })
            .catch((error) => console.error(error));

          // Update the remaining book information in the HTML
          document.getElementById("title").innerText = title;
          document.getElementById("year").innerText = year;
          document.getElementById("bookTitle").innerText = title;
          document.getElementById("author").innerText = author;
          document.getElementById(
            "cover"
          ).src = `https://covers.openlibrary.org/b/id/${cover}-L.jpg`;
          document.getElementById(
            "buyLink"
          ).href = `https://www.amazon.com/s?k=${title} ${author}`;
        })
        .catch((error) => console.error(error));
    </script>
  </body>
</html>
